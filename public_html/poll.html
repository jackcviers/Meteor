<html>
<body>
<script type="text/javascript">
window.onError = null;
var domainparts = document.domain.split(".");
var thisdomain = document.domain;
var topdomain = domainparts[domainparts.length-2]+"."+domainparts[domainparts.length-1];
document.domain = topdomain;
var lastrequesttime = 0;
var pollreq = false;
var polltimer = false;
parent.Meteor.register(this);

Function.prototype.bind = function(obj) {
	var method = this,
	temp = function() {
		return method.apply(obj, arguments);
	};
	return temp;
}

function newXmlHttp() {
	var xmlhttp;
	/*@cc_on @*/
	/*@if (@_jscript_version >= 5)
		try {
			xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (e) {
			try {
				xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
			} catch (E) {
				xmlhttp = false;
			}
		}
	@end @*/
	if (!xmlhttp && typeof XMLHttpRequest!='undefined') {
		xmlhttp = new XMLHttpRequest();
	}
	return xmlhttp;
}

function poll() {
	if (polltimer) clearTimeout(polltimer);
	var byteoffset = 0;
	var newdata;
	document.domain = topdomain;
	var url = "http://"+location.hostname+"/push?channel="+get("channel")+"&id="+get("MHostId")+"&persist="+get("persist")+"&template=2";
	if (get("lastmsgreceived") >= 0) {
		url += "&restartfrom="+(get("lastmsgreceived")+1);
	} else if (get("backtrack") > 0) {
		url += "&backtrack="+get("backtrack");
	} else if (typeof(get("backtrack")) != "number") {
		url += "&restartfrom=";
	}
	if (get("maxmessages") && get("persist")) url += "&maxmessages="+get("maxmessages");
	var now = new Date();
	var t = now.getTime();
	url += "&nocache="+t;
	try {
		document.domain = thisdomain;
	} catch (e) {}
	pollreq = newXmlHttp();
	pollreq.open("GET", url, true);
	pollreq.onreadystatechange = handleresponse.bind(pollreq);
	lastrequesttime = t;
	if (get("polltimeout")) polltimer = setTimeout(ptimeout, get("polltimeout"));
	pollreq.send(null);
	document.domain=topdomain;
}

function handleresponse() {
	if (this.readyState == 4) {
		if (typeof(topdomain) == "undefined") return false;
		document.domain=topdomain;
		newdata = this.responseText;
		var x = newdata.indexOf("parent.Meteor.setServerTime(");
		if (x != -1) {
			y = newdata.indexOf(");", x);
			if (y != -1) eval(newdata.substring(x,y+2));
		}
		while (1) {
			var x = newdata.indexOf("<s"+"cript>p(");
			if (x != -1) {
				y = newdata.indexOf("</"+"script>", x);
				if (y != -1) {
					eval(newdata.substring((x+8),y));
					newdata = newdata.substring(y+9);
				} else {
					break;
				}
			} else {
				break;
			}
		}
		var now = new Date();
		var t = now.getTime();
		var x = get("pollfreq") - (t-lastrequesttime);
		if (x < 10) x = 10;
		setTimeout(poll, x);
	}
}

function ptimeout() {
	if (typeof(pollreq) == "object") {
		pollreq.abort();
		delete pollreq;
	}
	poll();
}

poll();

</script>
</body>
</html>