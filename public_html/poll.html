<html>
<body>
<script type="text/javascript">
window.onError = null;
var domainparts = document.domain.split(".");
var thisdomain = document.domain;
var topdomain = domainparts[domainparts.length-2]+"."+domainparts[domainparts.length-1];
document.domain = topdomain;
var lastrequesttime = 0;
var pollreq = false;
var polltimer = false;
var i=0;
var isaborted = 0;
parent.Meteor.register(this);

Function.prototype.bind = function(obj) {
	var method = this,
	temp = function() {
		return method.apply(obj, arguments);
	};
	return temp;
}

function newXmlHttp() {
	var xmlhttp;
	/*@cc_on @*/
	/*@if (@_jscript_version >= 5)
		try {
			xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (e) {
			try {
				xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
			} catch (E) {
				xmlhttp = false;
			}
		}
	@end @*/
	if (!xmlhttp && typeof XMLHttpRequest!='undefined') {
		xmlhttp = new XMLHttpRequest();
	}
	return xmlhttp;
}

function poll() {
	isaborted = 0;
	try {
		clearTimeout(polltimer);
	} catch (e) {}
	var byteoffset = 0;
	var newdata;
	document.domain = topdomain;
	var url = get("subsurl");
	if (typeof(url)!="undefined") {
		var now = new Date();
		var t = now.getTime();
		url += "&template=2&nocache="+t;
		try {
			document.domain = thisdomain;
		} catch (e) {}
		pollreq = newXmlHttp();
		pollreq.onreadystatechange = handleresponse;
		pollreq.open("GET", url, true);
		lastrequesttime = t;
		if (get("polltimeout")) polltimer = setTimeout(ptimeout, get("polltimeout"));
		pollreq.send(null);
	}
	document.domain=topdomain;
}

function handleresponse() {
	if (typeof(pollreq) == "object" && pollreq.readyState == 4 && !isaborted) {
		try {
			clearTimeout(polltimer);
		} catch (e) {}
		if (typeof(topdomain) == "undefined") return false;
		document.domain=topdomain;
		newdata = pollreq.responseText;
		var x = newdata.indexOf("parent.Meteor.setServerTime(");
		if (x != -1) {
			y = newdata.indexOf(");", x);
			if (y != -1) eval(newdata.substring(x,y+2));
		}
		while (1) {
			var x = newdata.indexOf("<s"+"cript>p(");
			if (x != -1) {
				y = newdata.indexOf("</"+"script>", x);
				if (y != -1) {
					eval(newdata.substring((x+8),y));
					newdata = newdata.substring(y+9);
				} else {
					break;
				}
			} else {
				break;
			}
		}
		var now = new Date();
		var t = now.getTime();
		var x = get("pollfreq") - (t-lastrequesttime);
		if (x < 10) x = 10;
		setTimeout(poll, x);
	}
}

function ptimeout() {
	isaborted = 1;
	pollreq.abort();
	delete pollreq;
	clearTimeout(polltimer);
	var now = new Date();
	var t = now.getTime();
	var x = get("pollfreq") - (t-lastrequesttime);
	if (x < 10) x = 10;
	setTimeout(poll, x);
}

poll();

</script>
</body>
</html>