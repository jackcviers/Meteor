<html>
<body>
<script type="text/javascript">
window.onError = null;
var domainparts = document.domain.split(".");
document.domain = domainparts[domainparts.length-2]+"."+domainparts[domainparts.length-1];
parent.Meteor.register(this);
var streamreq;
var byteoffset;

function abort() {
	streamreq.abort();
}

function newXmlHttp() {
    try { return new ActiveXObject("Msxml2.XMLHTTP"); } catch (e) {}
    try { return new ActiveXObject("Microsoft.XMLHTTP"); } catch (e) {}
    try { return new XMLHttpRequest(); } catch(e) {}
    return null;
}

function startstream() {
	streamreq = newXmlHttp();
	byteoffset = 0;
	var url = parent.Meteor.getSubsUrl();
	streamreq.open("GET", url, true);
	streamreq.onreadystatechange = function() {
		if (typeof streamreq == "undefined") return;
		if (streamreq.readyState == 3) {
			var buffer = streamreq.responseText;
			var newdata = buffer.substring(byteoffset);
			byteoffset = buffer.length;
			while (1) {
				var x = newdata.indexOf("<s"+"cript>");
				if (x != -1) {
					y = newdata.indexOf("</"+"script>", x);
					if (y != -1) {
						eval(newdata.substring((x+8),y));
						newdata = newdata.substring(y+9);
					} else {

						// Last message is incomplete.  Ignore it and it will be fetched again
						break;
					}
				} else {

					// No more messages
					break;
				}
			}
			byteoffset = buffer.length-newdata.length;
		} else if (streamreq.readyState == 4) {
			delete streamreq;
			if (typeof(r)=="function") {
				r();
			}
		}
	}
	streamreq.send(null);
}



startstream();
</script>
</body>
</html>