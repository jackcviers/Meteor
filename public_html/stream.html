<html>
<body>
<script type="text/javascript">
window.onError = null;
var domainparts = document.domain.split(".");
document.domain = domainparts[domainparts.length-2]+"."+domainparts[domainparts.length-1];
parent.Meteor.register(this);
var streamreq;
var byteoffset;

Function.prototype.bind = function(obj) {
	var method = this,
	temp = function() {
		return method.apply(obj, arguments);
	};
	return temp;
}

function abort() {
	streamreq.abort();
}

function newXmlHttp() {
	var xmlhttp;
	/*@cc_on @*/
	/*@if (@_jscript_version >= 5)
	try {
		xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
	} catch (e) {
		try {
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
		} catch (E) {
			xmlhttp = false;
		}
	}
	@end @*/
	if (!xmlhttp && typeof XMLHttpRequest!='undefined') {
		xmlhttp = new XMLHttpRequest();
	}
	return xmlhttp;
}

function startstream() {
	streamreq = newXmlHttp();
	byteoffset = 0;
	var url = "http://"+location.hostname+"/push?channel="+get("channel")+"&id="+get("MHostId")+"&template=2";
	if (get("lastmsgreceived") >= 0) {
		url += "&restartfrom="+(get("lastmsgreceived")+1);
	} else if (get("backtrack") > 0) {
		url += "&backtrack="+get("backtrack");
	} else if (typeof(get("backtrack")) != "number") {
		url += "&restartfrom=";
	}
	var now = new Date();
	var t = now.getTime();
	url += "&nocache="+t;
	streamreq.open("GET", url, true);
	streamreq.onreadystatechange = handleresponse.bind(streamreq);
	streamreq.send(null);
}

function handleresponse() {
	if (this.readyState == 3) {
		var buffer = this.responseText;
		var newdata = buffer.substring(byteoffset);
		byteoffset = buffer.length;
		var x = newdata.indexOf("parent.Meteor.setServerTime(");
		if (x != -1) {
			y = newdata.indexOf(");", x);
			if (y != -1) eval(newdata.substring(x,y+2));
		}
		while (1) {
			var x = newdata.indexOf("<s"+"cript>p(");
			if (x != -1) {
				y = newdata.indexOf("</"+"script>", x);
				if (y != -1) {
					eval(newdata.substring((x+8),y));
					newdata = newdata.substring(y+9);
				} else {

					// Last message is corrupt or incomplete.  Ignore it and it will be fetched again
					break;
				}
			} else {

				// No more messages
				break;
			}
		}
		byteoffset = buffer.length-newdata.length;
	} else if (this.readyState == 4) {
		delete streamreq;
		if (typeof(startstream)=="function") {
			startstream();
		} else if (typeof(r)=="function") {
			r();
		}
	}
}

startstream();
</script>
</body>
</html>